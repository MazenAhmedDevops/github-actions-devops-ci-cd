name: Build & Test Hotel App (Reusable)

# -----------------------------
# Reusable workflow for building & testing the hotel app
# Can be called from other workflows (matrix or single runs)
# -----------------------------
on:
  workflow_call:
    inputs:
      os:
        required: false
        default: ubuntu-latest
        type: string    
      compiler:
        required: false
        default: g++
        type: string
      build-type:
        required: false
        default: Release
        type: string

env:
  HOME_DIR: $HOME
        
jobs:
  build-test-app:
    runs-on: ${{ inputs.os }}

    steps:
      # -----------------------------
      # Checkout the repository
      # -----------------------------
      - uses: actions/checkout@v4

      # -----------------------------
      # Ensure the directory exists before caching
      # -----------------------------
      - name: Ensure FetchContent cache directory exists
        shell: bash
        run: |
          # Detect HOME fallback and persist it to env
          HOME_DIR="${HOME:-$RUNNER_TEMP}"
          echo "HOME_DIR=$HOME_DIR" >> $GITHUB_ENV
          echo "Using HOME_DIR=$HOME_DIR"

          # Create directories
          mkdir -p "${HOME_DIR}/.cache/ccache"
          mkdir -p "${HOME_DIR}/.cmake/FetchContent"

          # Print to verify
          ls -ld "$HOME_DIR/.cmake" "$HOME_DIR/.cache"

      # -----------------------------
      # Install required tools (Linux)
      # -----------------------------
      - name: Install Linux Tools
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential ccache

      # -----------------------------
      # Install required tools (macOS)
      # -----------------------------
      - name: Install macOS Tools
        if: runner.os == 'macOS'
        run: |
          brew list cmake || brew install cmake

      # -----------------------------
      # Install required tools (Windows)
      # -----------------------------
      - name: Install Windows Tools
        if: runner.os == 'Windows'
        run: |
          choco list --local-only cmake || choco install cmake -y

      # -----------------------------
      # Configure ccache (Linux only for now)
      # -----------------------------
      - name: Configure ccache
        if: runner.os == 'Linux'
        run: |
          ccache --set-config=sloppiness=time_macros
          ccache --set-config=compression=true
          ccache --set-config=compression_level=5
      # -----------------------------
      # Configure CMake build (Linux only for now)
      # -----------------------------
      - name: Configure CMake (Linux)
        if: runner.os == 'Linux'
        run: >
          cmake -S . -B build
          -DCMAKE_CXX_COMPILER=${{ inputs.compiler }}
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          -DCMAKE_BUILD_TYPE=${{ inputs.build-type }}
          -DFETCHCONTENT_BASE_DIR=${{ env.HOME_DIR }}/.cmake/FetchContent

      # -----------------------------
      # Configure CMake build (non-linux os)
      # -----------------------------
      - name: Configure CMake (non-Linux)
        if: runner.os != 'Linux'
        run: >
          cmake -S . -B build
          -DCMAKE_CXX_COMPILER=${{ inputs.compiler }}
          -DCMAKE_BUILD_TYPE=${{ inputs.build-type }}
          -DFETCHCONTENT_BASE_DIR=${{ env.HOME_DIR }}/.cmake/FetchContent

      # -----------------------------
      # Normalize build configuration
      # -----------------------------
      - name: Normalize build configuration
        id: buildcfg
        shell: bash
        run: |
          echo "config=${{ inputs.build-type }}" >> $GITHUB_OUTPUT

      # -----------------------------
      # Cache CMake FetchContent dependencies (GoogleTest, etc.)
      # to avoid re-downloading on each build
      # Uses OS-specific key, compiler info and 
      # hash of CMakeLists.txt to invalidate cache if 
      # dependencies change
      # -----------------------------
      - name: Cache CMake FetchContent
        uses: actions/cache@v4
        with:
          path: ${{ env.HOME_DIR }}/.cmake/FetchContent
          key: >
            fetchcontent
            -${{ runner.os }}
            -${{ inputs.compiler }}
            -${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            fetchcontent-${{ runner.os }}-${{ inputs.compiler}}-
            fetchcontent-${{ runner.os }}-

      # -----------------------------
      # Cache ccache (Linux only)
      # Uses OS-specific key and compiler info to invalidate 
      # cache if dependencies change
      # -----------------------------
      - name: Cache ccache
        if: runner.os == 'Linux'
        uses: actions/cache@v4
        with:
          path: ${{ env.HOME_DIR }}/.cache/ccache
          key: >
            ccache
            -${{ runner.os }}
            -${{ inputs.compiler }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ inputs.compiler}}-
            ccache-${{ runner.os }}-

      # -----------------------------
      # Build test target
      # -----------------------------
      - name: Build hotel_app_tests
        run: >
          cmake --build build
          --target hotel_app_tests
          --config ${{ steps.buildcfg.outputs.config }}

      # -----------------------------
      # Build application executable
      # -----------------------------
      - name: Build hotel_app
        run: >
          cmake --build build
          --target hotel_app
          --config ${{ steps.buildcfg.outputs.config }}

      # -----------------------------
      # Run app tests
      # -----------------------------
      - name: Run App Tests
        run: >
          ctest
          --test-dir build/Application/tests
          --build-config ${{ steps.buildcfg.outputs.config }}
          --output-on-failure

      # -----------------------------
      # Upload test reports for artifact analysis
      # -----------------------------
      - name: Upload App Test Report
        uses: actions/upload-artifact@v4
        with:
          name: Application_test_report-${{ runner.os }}-${{ inputs.compiler }}
          path: build/Application/tests/Testing/Temporary

      # -----------------------------
      # Upload app binary (Linux)
      # -----------------------------
      - name: Upload App Binary (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: hotel_app_executable-${{ runner.os }}-${{ inputs.compiler }}
          path: build/Application/hotel_app

      # -----------------------------
      # Upload app binary (Windows)
      # Use globbing to catch Debug/Release builds without caching entire Chocolatey
      # -----------------------------
      - name: Upload App Binary (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: hotel_app_executable-${{ runner.os }}-${{ inputs.compiler }}
          path: build/Application/**/hotel_app.exe

      # -----------------------------
      # Upload app binary (macOS)
      # -----------------------------
      - name: Upload App Binary (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: hotel_app_executable-${{ runner.os }}-${{ inputs.compiler }}
          path: build/Application/hotel_app

      # -----------------------------
      # Show ccache statistics & config
      # -----------------------------
      - name: ccache statistics & config
        if: runner.os == 'Linux'
        run: |
          ccache --show-stats
          ccache --show-config