name: Library Quality Checks

# -----------------------------
# Triggers
# -----------------------------
# - Manual trigger (workflow_dispatch)
# - Automatic trigger when 
#   a PR on master branch is opened/updated and library code is changed 
#   or the workflows (build-and-test-lib.yml or Ci-library-quality-checks.yml) are updated
on:
  workflow_dispatch:
  pull_request: 
    branches: [ master ]
    paths:
      - 'hotel_lib/**'
      - '.github/workflows/build-and-test-lib.yml'
      - '.github/workflows/Ci-library-quality-checks.yml'

#This ensures only the latest CI runs per branch execute.
concurrency:
  group: ci-${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  library:
    uses: ./.github/workflows/build-and-test-lib.yml
    with:
      compiler: g++

  quality:
    runs-on: ubuntu-latest
    needs: library  # Ensure library tests passed
    steps:
      # Checkout code
      - uses: actions/checkout@v4

      # Install linting and coverage tools
      - name: Install Tools
        run: sudo apt-get update && sudo apt-get install -y clang-tidy lcov

      # Configure CMake before running clang-tidy
      # Build library with coverage
      - name: Build Library with Coverage
        run: cmake -S . -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_CXX_FLAGS="--coverage"

      # -----------------------------
      # Run static analysis (library only)
      # Uses the compilation database
      # -----------------------------
      - name: clang-tidy (library)
        run: |
          clang-tidy \
            hotel_lib/src/*.cpp \
            hotel_lib/tests/*.cpp \
            -p build

      # ----------------------------- 
      # Build and run tests
      # This generates runtime coverage data
      # -----------------------------
      - name: Run Library Tests
        run: |
          cmake --build build --target hotel_lib_tests
          ctest --test-dir build/hotel_lib --output-on-failure
          
      # -----------------------------
      # Capture Coverage Information
      # -----------------------------
      # - Collects execution data generated by gcov
      # - Ignores known LCOV/GTest line-mapping mismatches
      # - Normalizes unexecuted blocks to avoid false failures
      #
      # NOTE:
      # These flags are REQUIRED for modern C++ + GoogleTest
      # to prevent CI failures caused by tooling artifacts.
      - name: Capture Coverage
        run: |
          lcov \
            --directory build/hotel_lib \
            --capture \
            --output-file build/hotel_lib/coverage.info \
            --ignore-errors mismatch \
            --rc geninfo_unexecuted_blocks=1

      # -----------------------------
      # Filter Coverage Data
      # -----------------------------
      # - Removes test files from coverage results
      # - Excludes system and standard library headers
      #
      # WHY:
      # Coverage should measure production code quality,
      # not test harnesses or compiler internals.
      - name: Filter Coverage
        run: |
          lcov --remove build/hotel_lib/coverage.info \
            '*/tests/*' \
            '/usr/*' \
            --output-file build/hotel_lib/coverage.filtered.info

      # Upload coverage report
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage_report
          path: build/hotel_lib/coverage.filtered.info
